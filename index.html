<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peta Web Flores Timur</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <!-- Bootstrap Icons CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        html, body { height: 100%; margin: 0; padding: 0; display: flex; flex-direction: column; }
        #map { flex-grow: 1; width: 100%; }
        .legend {
            line-height: 1.5; color: #333; padding: 8px 12px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: rgba(255, 255, 255, 0.9); box-shadow: 0 0 15px rgba(0,0,0,0.2); border-radius: 5px;
        }
        .legend .title { font-size: 16px; margin-bottom: 8px; font-weight: bold; text-align: left; }
        .legend .legend-item { display: flex; align-items: center; margin-bottom: 4px; }
        .legend i { width: 18px; height: 18px; margin-right: 8px; opacity: 0.9; border: 1px solid #555; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Flores Timur</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto"></ul>
                <form class="d-flex me-2" id="searchForm">
                    <input class="form-control me-2" type="search" placeholder="Cari Kecamatan..." aria-label="Search" id="searchInput" list="kecamatanList">
                    <datalist id="kecamatanList"></datalist>
                    <button class="btn btn-outline-light" type="submit">Cari</button>
                </form>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#aboutModal">
                            <i class="bi bi-info-circle"></i> Tentang
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div id="map"></div>

    <!-- Feature Modal -->
    <div class="modal fade" id="featureModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="featureModalLabel"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="featureModalBody"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                </div>
            </div>
        </div>
    </div>

    <!-- About Modal -->
    <div class="modal fade" id="aboutModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-info-circle-fill"></i> Tentang Peta Ini</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Nama: Idhea Fasih Pratiwi</p>
                    <p>NIM: 25/569123/SV/27605</p>
                    <p>Kelas: PGWeb A</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Mengerti</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const map = L.map('map').setView([-8.43, 122.98], 10);

        map.createPane('batasKecamatanPane'); map.getPane('batasKecamatanPane').style.zIndex = 420;
        map.createPane('sungaiPane'); map.getPane('sungaiPane').style.zIndex = 430;
        map.createPane('jalanPane'); map.getPane('jalanPane').style.zIndex = 440;
        map.createPane('toponimiPane'); map.getPane('toponimiPane').style.zIndex = 450;

        const baseMaps = {
            "OpenStreetMap": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map),
            "Esri Satellite": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles &copy; Esri' })
        };

        function getKecamatanColor(d) { return d > 30000 ? '#994C00' : d > 15000 ? '#B25900' : '#E57300'; }
        function styleKecamatan(feature) { return { fillColor: getKecamatanColor(feature.properties.Penduduk), weight: 1.5, opacity: 1, color: 'white', dashArray: '3', fillOpacity: 0.8 }; }
        function styleJalan(feature) {
            const unsur = feature.properties.NAMA_UNSUR;
            let weight = 1;
            if (unsur === 'Jalan Provinsi') weight = 4;
            else if (unsur === 'Jalan Kabupaten') weight = 3;
            else if (unsur === 'Jalan Lain') weight = 2;
            return { color: "#FF0000", weight: weight, opacity: 0.9 };
        }

        async function loadLayers() {
            try {
                const [kecamatanData, jalanData, sungaiData, toponimiData] = await Promise.all([
                    fetch('data/batas_kecamatan.geojson').then(res => res.json()),
                    fetch('data/jalan.geojson').then(res => res.json()),
                    fetch('data/sungai.geojson').then(res => res.json()),
                    fetch('data/toponimi.geojson').then(res => res.json())
                ]);

                const kecamatanLayer = L.geoJSON(kecamatanData, {
                    style: styleKecamatan, pane: 'batasKecamatanPane',
                    onEachFeature: function (feature, layer) {
                        if (feature.properties && feature.properties.WADMKC) layer.bindTooltip(feature.properties.WADMKC, { sticky: true });
                        layer.on('click', () => {
                            const props = feature.properties;
                            document.getElementById('featureModalLabel').textContent = `Kecamatan ${props.WADMKC}`;
                            document.getElementById('featureModalBody').innerHTML = `<p><i class="bi bi-people-fill"></i> <strong>Jumlah Penduduk:</strong> ${props.Penduduk ? props.Penduduk.toLocaleString('id-ID') : 'N/A'}</p>`;
                            new bootstrap.Modal(document.getElementById('featureModal')).show();
                        });
                    }
                });
                const jalanLayer = L.geoJSON(jalanData, { style: styleJalan, pane: 'jalanPane' });
                const sungaiLayer = L.geoJSON(sungaiData, { style: { color: "#0000FF", weight: 1.5, opacity: 0.9 }, pane: 'sungaiPane' });
                const toponimiLayer = L.geoJSON(toponimiData, { pane: 'toponimiPane', onEachFeature: (f, l) => { if (f.properties && f.properties.NAMOBJ) l.bindPopup(f.properties.NAMOBJ); } });

                const overlayMaps = {
                    "Toponimi": toponimiLayer,
                    "Jalan": jalanLayer,
                    "Sungai": sungaiLayer,
                    "Batas Kecamatan": kecamatanLayer
                };

                [kecamatanLayer, jalanLayer, sungaiLayer, toponimiLayer].forEach(l => l.addTo(map));

                L.control.layers(baseMaps, overlayMaps).addTo(map);

                const legend = L.control({ position: 'bottomright' });
                legend.onAdd = function (map) {
                    const div = L.DomUtil.create('div', 'info legend');
                    let html = '<div class="title">Legenda</div>';
                    html += '<strong style="font-size: 14px;">Jumlah Penduduk</strong>';
                    const grades = [0, 15000, 30000];
                    grades.forEach((g, i) => {
                        html += `<div class="legend-item"><i style="background:${getKecamatanColor(g + 1)}"></i> <span>${g.toLocaleString('id-ID')}${grades[i+1] ? '&ndash;'+grades[i+1].toLocaleString('id-ID') : '+'}</span></div>`;
                    });
                    html += '<strong style="font-size: 14px; display: block; margin-top: 10px;">Jenis Jalan</strong>';
                    const jalanTypes = {'Jalan Provinsi': 4, 'Jalan Kabupaten': 3, 'Jalan Lain': 2};
                    for (const type in jalanTypes) {
                        html += `<div class="legend-item"><i style="background: #FF0000; height: ${jalanTypes[type]}px; width: 20px; border: none; margin-top: ${(18 - jalanTypes[type]) / 2}px;"></i> <span>${type}</span></div>`;
                    }
                    html += '<strong style="font-size: 14px; display: block; margin-top: 10px;">Lainnya</strong>';
                    html += `<div class="legend-item"><i style="background: #0000FF; height: 2px; width: 20px; border: none; margin-top: 8px;"></i> <span>Sungai</span></div>`;
                    div.innerHTML = html;
                    return div;
                };
                legend.addTo(map);

                const datalist = document.getElementById('kecamatanList');
                kecamatanData.features.forEach(f => { datalist.innerHTML += `<option value="${f.properties.WADMKC}"></option>`; });

                document.getElementById('searchForm').addEventListener('submit', function(e) {
                    e.preventDefault();
                    const searchValue = document.getElementById('searchInput').value;
                    let foundLayer = null;
                    kecamatanLayer.eachLayer(layer => { if (layer.feature.properties.WADMKC.toLowerCase() === searchValue.toLowerCase()) foundLayer = layer; });
                    if (foundLayer) {
                        map.flyToBounds(foundLayer.getBounds());
                        foundLayer.fire('click');
                    } else {
                        alert('Kecamatan tidak ditemukan!');
                    }
                });

            } catch (error) {
                console.error("Gagal memuat layer: ", error);
                alert("Gagal memuat data layer. Periksa konsol untuk detail.");
            }
        }

        loadLayers();
    </script>
</body>
</html>
